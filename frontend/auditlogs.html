<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Payables Payment Screen ~ Stripe</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="Payables Payment Screen ~ Stripe" name="description" />
    <link href="css/global.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" id="bootstrap-css" rel="stylesheet">
    <link href="//cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css" rel="stylesheet">

    <link crossorigin="anonymous" href="//use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="//js.stripe.com/v3/"></script>
    <script>
        var url = location.origin + location.href.replace(location.origin, '').substr(0, location.href.replace(location.origin, '').lastIndexOf('/'));
    </script>
</head>

<style>
    .hover\:text-pasha:hover {
        --text-opacity: 1;
        color: #f79910 !important;
        border: 1px solid #f79910;
        font-family: sans-serif;
    }

    .hover\:shadow-outline:hover {
        box-shadow: none !important;
    }
</style>

<body>

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation"
        style="padding: 0 15px;background-color: #ffffff;">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse"
                type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index"><img src="img/logo7.png" style="width: 45%;" /></a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <!--            <li class="active"><a href="#">Link</a></li>-->
                <!--            <li><a href="#">Link</a></li>-->
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/index">
                        <i class="fas fa-arrow-left"></i> &nbsp; Back to Dashboard
                    </a>
                </li>

                <li>
                    <a href="mailto:tulsihelpdesk@gmail.com" target="_blank">
                        Feedback</a>
                </li>

                <li class="dropdown">
                    <a class="dropbtn" style="display: flex;height: 78px;"><span id="userimage"><img
                                src="img/Profilepic.webp" style="max-height: 40px; border-radius: 50%;" /> &nbsp;
                        </span><span id="username" style="margin-left: 10px;">Not LoggedIn</span> </a>
                    <div class="dropdown-content">
                        <a href="/auditlogs" target="_self">Audit Logs</a>
                        <a href="/pricing" onclick="GotoPricing();"><span id="signout">Manage Subscription</span></a>
                        <a href="/collaborators" target="_self">Teams & Permissions</a>
                        <a href="mailto:tulsihelpdesk@gmail.com" target="_blank">Report a bug</a>
                        <a href="http://www.google.com" target="_blank">Helpdesk</a>
                        <a href="#" style="background: #f88da5; color: #fff; font-weight: 700;"
                            onclick="SignOutFirebase();"><span id="signout">Logout</span> &nbsp; <i
                                class="fas fa-sign-out-alt"></i></a>
                    </div>
                </li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </nav>


    <div class="container" style="margin-top: 100px;
    background: #fff;
    padding: 2%;
    border-radius: 6px;
    box-shadow: 2px 7px 20px 7px #8a8a8a14;
    border: 2px solid #f3f3f3;">

    <div class="row" style="margin-left: 48px;
    padding-bottom: 22px;
    margin-top: 26px;
    box-shadow: 4px 5px 21px 0 rgba(43, 43, 43, 0.2);
    border-radius: 4px;
    overflow: hidden;
    background: #ffffff url(../img/5ede8c0â€¦_scene_1.png) 101% 11% no-repeat;
    background-repeat: no-repeat;
    background-size: 50% 100%;
    background-position-x: 100%;
    background-position-y: 38%;
    margin: 0%;
    padding: 23px;
    background-color: #fafafa;
    font-weight: 700;
    font-size: 16px;">

                <h2 style="text-align:left; margin-top: 0;">Audit Log</h2>
                <p style="text-align:left;font-weight: 300;">Keep an eye on all the changes within the system, like having a bird's eye view to each change.</p>
        </div>

        <div class="justify-center" style="margin-top:20px;" id="prices-and-payment">
            <div class="settings_setup_container">

                <table id='timeline-tab' class="clean_table">
                    <colgroup>
                        <col span="1" style="background-color: #efefef; border-left: 1px solid #9999;">
                    </colgroup>
                    <thead>
                        <tr>
                            <!--Table Header-->
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Transaction type</th>
                            <th>Dated</th>
                            <th>Amounted</th>
                            <!--End Table Header-->
                        </tr>
                    </thead>
                    <tbody id='audit-log-tbody'>
                        <!-- <tr href="#" style="cursor:pointer;">
                        <th colspan="6" style="text-align: center;">View All Entries</th>
                        </tr> -->
                        <!--End Row-->
                        <tr class="loading_rows">
                            <td colspan="6" style="display:flex; text-align:center;"><img src="img/loader.svg" /> &nbsp; Loading table results...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>

    <script defer src="js/mFirebase.js"></script>
    <script>
        var db, UserObject;
        var fireBaseConfigInfo;
        function getFirebaseConfig() {
            return fetch('/firebaseConfig', {
                method: 'get',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then((response) => {
                    return response.json();
                })
                .then((response) => {
                    fireBaseConfigInfo = response;
                    console.log(fireBaseConfigInfo);

                });
        }
        var secondaryApp;
        function initializeFirebase1() {
            getFirebaseConfig().then(function () {
                var firebaseConfig = fireBaseConfigInfo;
                //initialize firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);

                    secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
                    db = firebase.firestore();
                }

                firebase.auth().onAuthStateChanged(function (user) {

                    if (user) {
                        UserObject = user;
                        getAuditLog();
                    } else {
                        location.href = url + "/signin";
                    }
                });

            });

        }
        var ViewOnly = false;
        $(document).ready(function () {
            initializeFirebase1();
            if (localStorage.getItem("access") != "Owner") {
                //ViewOnly =true;
                location.href = url + "/index";
            }
        });
        async function getAuditLog() {
          //  var current = await getUserData();
            var arr = [];
            const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'June', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];

            await db.collection("tbl_audit_log").where("refId", "==", UserObject.uid).get()
                .then(querySnapshot => {
                    querySnapshot.forEach(val => {
                        arr.push(val.data());
                    })
                }).catch(err => {
                    console.log(err);
                })

            var data = arr.slice(0);
            data.sort(function (a, b) {
                return b.now - a.now;
            });

            var tbody = document.getElementById('audit-log-tbody');
            tbody.innerHTML = '';
            //     db.collection('tbl_audit_log').add({
            //     content: `Transaction ${transaction_id} updated as signed</b>`,
            //     now: (new Date()).getTime(),
            //     party: '',
            //     date: '',
            //     amount: '',
            //     refId: UserObject.uid,
            //     collection: 'Transactions'
            // });
            for (let i = 0; i < data.length; i++) {
                var d = new Date(parseInt(data[i].now));
                var date = d.getDate() + " " + MONTHS[d.getMonth()] + " " + d.getFullYear();
                var hours = 0;
                var zone = 'am';
                if (d.getHours() > 12) {
                    hours = d.getHours() - 12;
                    zone = 'pm'
                } else {
                    hours = d.getHours()
                }
                var time = hours + ":" + d.getMinutes() + zone;
                var tr = document.createElement('tr');
                tr.innerHTML = `<td><b>${date}</b> ${time}</td>
            <td>${data[i].user ? data[i].user : UserObject.displayName}</td>
            <td>${data[i].content}</td>
            <td>${data[i].party ? data[i].party : ''}</td>
            <td>${data[i].date ? data[i].date : ''}</td>
            <td>${data[i].amount ? data[i].amount : ''}</td>`;
                tbody.appendChild(tr)
            }
        }

        function SignOutFirebase() {
            firebase.auth().signOut().then(function () {
                location.href = url + "/signin";
            }).catch(function (error) {
                // An error happened.
            });
        }
    </script>
    <style>
        .navbar-nav>li>a {
            padding-top: 20px !important;
            padding-bottom: 10px !important;
            width: auto !important;
            border-right: 1px solid !important;
            line-height: 3 !important;
            border-right: 1px solid #ebebeb !important;
        }
    </style>
</body>

</html>
