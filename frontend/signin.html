<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>Payables ~ Login</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css" rel="stylesheet">
    <link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/select2.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

</head>
<style>
    .firebaseui-idp-button {
        border: double;
        border-radius: 5px;
        box-shadow: 1px 1px 13px 3px #ececec;
    }
</style>

<body style="display:none;background: #f9f9f9;">
    <!--<button type="button" onclick="googleSignInClicked()">Google SignIn</button>-->
    <div style="border-radius: 7px;
    box-shadow: 0px 2px 5px 9px #e8e8e833;
    margin: 3% auto;
    overflow: hidden;
    padding: 0px;
    width: fit-content;
    background: #ffff;
    border: ridge;padding-top: 2%;">
   
    <div>
        <div id="google-signin">
            <a href="#"><img src="img/logo7.png" style="width: 53%;margin: auto 22%;" /></a>
            <br>
            <h3 style="text-align: center;font-family: monospace;margin-top: 10%;">Run an organized business today</h3>
        </div>
            <div>
                <div style="margin-bottom: 10px; width: 70%;"><span style="font-weight: bold;color: crimson;" id="login_error"></span></div>
                <div style="margin-bottom: 20px;">
                    <span style="text-align: left;padding: 15px;margin-bottom: 10px;">Email:</span> <input style="width: 210px;" id="email" type="text" />
                </div>
                <div style="margin-bottom: 20px;">
                    </span> Password: </span> <input id="password" style="width: 210px;" type="password" />
                </div>
                <button id="siginIndirectly" onclick="signInUsingEmailPassword();">Sign In</button>
            </div>
    </div>

        <a><img src="img/bannerwoman.png" style="width: 500px;" /></a>
    </div>

    <style>
        /**
* The CSS shown here will not be introduced in the Quickstart guide, but shows
* how you can use CSS to style your Element's container.
*/
        .StripeElement {
            box-sizing: border-box;
            height: 40px;
            padding: 10px 12px;
            border: 1px solid transparent;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 1px 3px 0 #e6ebf1;
            -webkit-transition: box-shadow 150ms ease;
            transition: box-shadow 150ms ease;
        }

        .StripeElement--focus {
            box-shadow: 0 1px 3px 0 #cfd7df;
        }

        .StripeElement--invalid {
            border-color: #fa755a;
        }

        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;
        }
    </style>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>
    <script>
        var url = location.origin + location.href.replace(location.origin, '').substr(0, location.href.replace(location.origin, '').lastIndexOf('/'));
    // var url = "https://clever-engelbart-ff8898.netlify.app/";
    </script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-firestore.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
    <script src="js/mFirebase.js"></script>
    <script src="js/signin.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" rel="stylesheet" type="text/css" />
    <div id="loader"></div>
    <input style="display:none;" id="customerid" value="" />
    <style>
        .errorClass {
            border: 1px solid red;
        }
    </style>
    <script>
        var UserObject;
        var email;
        function signInUsingEmailPassword() {
            $("#password").removeClass("errorClass");
            $("#email").removeClass("errorClass");
            email = $("#email").val();
            var password = $("#password").val();
            if (email) {
                if (password) {
                    firebase
                        .auth()
                        .signInWithEmailAndPassword(email, password)
                        .then(async (res) => {
                            console.log(res);
                        })
                        .catch(function (error) {
                            console.log(error);
                            $("#login_error").html(error.message);
                        });

                } else {
                    $("#password").addClass("errorClass");
                }
            } else {
                $("#email").addClass("errorClass");
            }
        }

        $(document).ready(function () {
            getFirebaseConfig().then(function () {
                console.log("came here first");
                initializeFirebase();
                getFirebaseConfig().then(function () {
                    firebase.auth().onAuthStateChanged(function (user) {
                        if (user) {
                            console.log(user);
                            UserObject = user;
                            db.collection("tbl_linked_account_access")
                                .doc(UserObject.uid)
                                .get()
                                .then((res) => {
                                    var data = res.data();
                                    console.log(data, UserObject);
                                    if (data) {
                                        localStorage.setItem("access", data.type);
                                        localStorage.setItem("user", data.user);
                                        localStorage.setItem("userid", data.UserID);
                                        localStorage.setItem("owner_email",data.owner_email);
                                        localStorage.setItem("current_userid", UserObject.uid);
                                        localStorage.setItem("islinkedaccount", true);
                                        db.collection('tbl_audit_log').add({
                                            content: `User logged in <b>${data.user}</b>`,
                                            now: (new Date()).getTime(),
                                            party: '',
                                            date: '',
                                            amount: '',
                                            refId:  localStorage.getItem("userid"),
                                            user: localStorage.getItem("user"),
                                            collection: 'login Activity'
                                        });
                                        location.href = url + "/index";
                                    } else {
                                        localStorage.setItem("access", "Owner");
                                        localStorage.setItem("user", UserObject.displayName);
                                        localStorage.setItem("userid", UserObject.uid);
                                        localStorage.setItem("current_userid", UserObject.uid);
                                        localStorage.setItem("owner_email",UserObject.email);
                                        localStorage.setItem("islinkedaccount", false);
                                        db.collection('tbl_audit_log').add({
                                            content: `User logged in <b>${ UserObject.displayName}</b>`,
                                            now: (new Date()).getTime(),
                                            party: '',
                                            date: '',
                                            amount: '',
                                            refId: localStorage.getItem("userid"),
                                            user: localStorage.getItem("user"),
                                            collection: 'login Activity'
                                        });
                                        tblStripeCustomers = db.collection("tbl_stripecustomers");
                                        tblStripeCustomers.where("UserID", "==", localStorage.getItem("userid")).where("CustomerEmail", "==", UserObject.email).get().then(function (querySnapshot) {
                                            if (querySnapshot.docs.length > 0) {
                                                console.log(querySnapshot);
                                                $("#customerid").val(querySnapshot.docs[0].data().customerid);
                                                getCustomerSubscriptions().then(function (response) {

                                                    if (response.length > 0) {
                                                        if (response[0].status == "active" || response[0].status == "trialing") {
                                                            location.href = url + "/index";
                                                        }
                                                    } else {
                                                        subscribeTrial();
                                                    }

                                                });
                                            } else {
                                                subscribeTrial();
                                            }
                                        });
                                    }
                                });
                            //location.href = url + "/index";
                        } else {
                            $("body").show();
                        }
                    });
                });
            });
        })
    </script>
    <script>
        var ui;
        $(document).ready(function () {
            getFirebaseConfig().then(function () {
                console.log("came here first");
                getFirebaseConfig().then(function () {
                    ui = new firebaseui.auth.AuthUI(firebase.auth());
                    var uiConfig = {
                        callbacks: {
                            signInSuccessWithAuthResult: function (authResult, redirectUrl) {
                                console.log(authResult);
                                return false;
                            },
                            uiShown: function () {
                                document.getElementById('loader').style.display = 'none';
                            }
                        },
                        // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
                        signInFlow: 'popup',
                        //  signInSuccessUrl: url + '/index',
                        signInOptions: [
                            firebase.auth.GoogleAuthProvider.PROVIDER_ID//,
                            //firebase.auth.FacebookAuthProvider.PROVIDER_ID,
                            //firebase.auth.TwitterAuthProvider.PROVIDER_ID,
                            //firebase.auth.GithubAuthProvider.PROVIDER_ID,
                            //firebase.auth.EmailAuthProvider.PROVIDER_ID,
                            //firebase.auth.PhoneAuthProvider.PROVIDER_ID
                        ],
                        // Terms of service url.
                        tosUrl: '<your-tos-url>',
                        // Privacy policy url.
                        privacyPolicyUrl: '<your-privacy-policy-url>'
                    };

                    ui.start('#google-signin', uiConfig);
                });
            });
        });
    </script>
</body>

</html>
